-- trigger - proc - function -- Teachers

-- Trigger CREATE teachers

CREATE OR ALTER TRIGGER trigger_Create_Teacher
on Teachers
AFTER INSERT
as
BEGIN
	-- Update Teachers TABLE
	UPDATE Teachers
	SET Photo = CASE WHEN inserted.Photo IS NULL THEN CONVERT(VARBINARY(MAX), '0x89504E470D0A1A0A0000000D494844520000012C0000012C0806000000797D8E7500000DF949444154785EEDDD7B7714C5DA40F1F3FDBF94120D2246F01215440515C115884A141151E65D0FABF29E3E35499864EA99A9EAF9EDB5F63F5C924E4FCF4E554D5FFEB3008041F84FFD0700D02B82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C4317C13A3E3E5E1C1C1C90ECD8A3A3A3FAADBB71BA08D6CF3FFFBC78E79D774876EC4F3FFD54BF75378E60915C49C12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255681DAC6BD7AE2DEEDEBD4BEEB47B7B7B4BEF8D7514AC42EB60BDF7DE7BF5B700768E0F3EF860E9BDB18E8255102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA23584908D662F1E2C58BC5C9C9C9E2F9F3E7F55F015742B092D8B560BD7EFD7A717C7CBCF8FAEBAF17D7AF5F5FDAFED39FE1F0F070717474B478F5EA55FD2580B7225849EC52B01E3D7A746EA4CE736F6F6F71FFFEFDC53FFFFC537F39E05C042B895D08D61F7FFCB1B879F3E6D2B65EC6FDFDFDC5D3A74FEB2F0D9C89602531F76045646294546FE755FDFEFBEFEB6F012C215849CC3958AD7FB65363FD0BB808C14AA2F59BBA97603D7BF66C71EDDAB5A5ED6B650F0710FA45B0929863B0FEFEFBEF376B4EF5B6B53462185104CE42B0929863B0BEF9E69BA5EDCAF0D6AD5BF5B7C68AFCFBEFBFF51FCD0AC14A626EC18A934033A782B54F9E3CA937012B70EFDEBD3727EBCE15C14A626EC1FAF6DB6F97B62953A3ACCBF3EBAFBF2EDE7DF7DDC5DDBB77EBBF9A0D8295C4DC82D5FA40799BF1C68B3533AC469C807BE3C68D37FB2E4E3799EB09B9AD8F43C12ACC2958718268BD3D9BB087836914622AB80BFB4EB0929853B0E245ADB76713DEB973A7DE149CC16FBFFDF666443ADD77070707F53F9B058295C49C82B5E9F5AB536FDFBE5D6F0A2AE253C1D3A960ED1C4F0F11AC24E614AC58C4ADB76713C6758AB8988B4E3599E30855B09210ACF515AC8B8911543D159C1AA7A1CCED363E8295C49C8275D16FF14C4D09CF27A6821F7EF8E1D23EAB7DF8F061FD5F8746B0929853B0B6B5E8FEE5975FD69B82C2AABF44E6364A15AC24E614AC987AD4DBB3097FFCF1C77A53B078FB54B0363E459C0B8295C49C8215B73F7EFFFDF797B629DB38FF0BFFCBAA53C1A9731AA90A5612730A56109F38D5DB94E9DCA632AD58752A383516DFE772D580602531B760C568E732D390758DFD87FFE5B253C1A973995E0B5612730B56B0A9D31B3EFAE8A337D350FC97980AAE73FFFC9846CE01C14A628EC1FAEBAFBFDE6C47BD6D2D8D11C42FBFFC527FEB9DE72A53C1DAB89BC3E8085612730C561031B9EAB464153D8C629975A68253E7B0F82E5849CC3558419C8C586F5F0BE7F0866ACDBA53C1A973587C17AC24E61CACE0F1E3C74DEF401A531EEB56CB7CF7DD774BFB6A1D7FF8E187FA5B0C85602531F76005315559F7008A9F2BE28765E256C72DA68253E3CE0E23B3EEF1562B58855D0856105396F8AD7DD9C5F8189DC57308479FA264D1722A583BF2871A8295C4AE04EB94B82BC0D1D1D1E2F0F0F0DC78C568E1D34F3F7DB306169F38E27C5A4F05A7C66B342A8295C4AE05AB26EE291E539A535FBE7C59FF139C43C654706A8C6E477D3D042B895D0F16AE46E65470EAA8A78F08561282D52FBFFFFE7BB70F1CBD7FFFFED26B9F61BCF147FC5456B09210AC3E89A96A1CF4B196D65BB422A42D4F15799BC7C7C7F526748F602521587D327DA0C6679F7DD64DB4623BE21ACAFA75CFF4F3CF3FAF37A37B042B09C1EA8FB34630BD446B5353C1A9B1B03FDAA7B582958460F5C7AD5BB796F66B18238D6D46EBAC906ECA08E54808561282D5177160D6FB74EAB6A2B58DA9E0D4EBD7AF0FB5F82E584908563FC4D9F4ABDCE2791BD1DAC654B0F6E9D3A7F566758B60252158FD107781A8F7E7796E325A7117D76D4D05A7C63ADE2808561282D507F1C4987A5FBECDB874253B5A310D3B383858FADEDB3016DF5FBC78516F629708561282B57D223A977DC2CCA911ADCCB59D070F1E2C7DCF6D3ACAE2BB60252158DB272E3FA9F7E365CC8A562F53C1A9FBFBFB293F6B6B042B09C1DA2E7FFEF96793287CF1C5174DDFC83D4D056B9F3C79526F6E7708561282B55D6221B9DE8757B565B47A9B0A4EFDE4934FEACDED0EC14A42B0B647EB7D1FC6278DEB46ABC7A9E0D4587C8F9169CF085612ADDF3482B51A7171739C0C59EFBF16AE13ADF87F1F7FFCF1D2D7ECCDB8D6B267042B09C1DA0ED90F7BBD6AB4E236D2F5D7EAD1587CCF3EA5631D042B09C1DA3C714D5EE69D3A4FFDEAABAF2E15ADE7CF9F773D15AC8D5B5DF78A602521589B2502B2C96BF2225AAB30CA54706ACF8BEF829584606D96B75DDC9CE12AD11A652A58DBEBE2BB602521589B23EEE9B4B7B7B7B4CF36E19D3B77EACDF97F469B0A4E8D07DBF6886025B1CBC1DAF4A2ED652E6ECEF0AC688D38159C1A77B7D8F4EBB80A8295C4AE062B1ED2B9C9FBA5C7AD51EA7DB50DEB688D3A159C1AC7706F085612BB1AACD351452CDC66472BBE7E3C7ABDDE57DB324EA9085A5D16B46DE30EADBD215849EC62B0627435DDE6EC684D1F28D18B11AD91A782B5B10ED7138295C42E06EBAC37EAEDDBB753A235F282F648DEBB77AFDEF55B45B092D8B560D5A3ABA931B5884B665A72DE0325D8D6DE16DF052B895D0BD659A3ABA92DA3D57ADFF2621F3F7E5CBF045B43B09268FDA6EA3958178DAEA646D45EBD7A55FFF74BB1EA0325D8CE78DD7A41B092D8A560BD6D743575DD68655FDCCCB38D5BE3F4806025B12BC15A75743535EEB87995685DE581126CE3E9291BDB46B092D895605D66743535A215D3BB55D9F6034777DD38FE5AAD41AE836025B10BC1BACAE86A6A0468D568ADFB4009AEEFA3478FEA9765E3085612BB10ACAB8EAEA6AE12AD7866DEB62E6EE67FED61F15DB092987BB0D61D5D4DBD79F3E685D16AF94009AEE7C9C949FDF26C14C14A62EEC16A31BA9A1AD17AF9F265FD6DDE3C7AAAFEB7DC9EDB5E7C17AC24E61CAC96A3ABA975B4321F28C1AB1953F36D2EBE0B5612730E56EBD1D5D478B47CDC902F889BC8D57FCFEDBBCD37B9602531D760658DAEA646B4E23E579B78A0042F6F7C50B22D042B89B9062B7374C5717CF6EC597D686C04C14A628EC1DAC4E88A63B8CA03383210AC24E6182CA32B9E1AF722BBCAE555EB225849CC2D584657AC7DF8F0617D98A4235849CC2D584657AC8DD350368D602531A760195DF13CE30E1A9B44B0929853B08CAE789EF14CC84D225849CC25584657BCC8587CBFE83AD0D6085612730996D115DF663C347653085612730896D1155731AE4CD8148295C41C826574C5558D5F6E9B40B092183D584657BC8C9B5A7C17AC24460F96D1152FE3A616DF052B8991836574C5ABB889C577C14A62E460195DF12ADEB871A33E949A2358498C1A2CA32BAE63F6E2BB6025316AB08CAEB88E878787F521D514C14A62C460195D715DE32EB1673D4CA4158295C488C132BA620B1F3C78501F5ACD10AC24460B96D1155B195179FDFA757D883541B092182D58F1C2C533E7C816C6D3BA3310AC24460B1630028295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F6025D13A587B7B7B8B93931372A7DDDFDF5F7A6FACA360155A078B647B05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC102804B2058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C320580086E1FF003B3B5E31DD23C9C30000000049454E44AE426082') 
	ELSE inserted.Photo END
	FROM Teachers
	JOIN inserted on Teachers.TeacherID = inserted.TeacherID;

	IF EXISTS (SELECT * FROM inserted WHERE TeacherManagerID IS NULL)
	BEGIN 
		UPDATE Teachers
		SET Teachers.TeacherManagerID = inserted.TeacherID
		FROM Teachers
		INNER JOIN inserted ON Teachers.MajorID = inserted.MajorID
		WHERE Teachers.TeacherID <> inserted.TeacherID;
	END



	UPDATE T
    SET T.Email = ConCAT(ConCAT(dbo.prefixEmail(I.TeacherName), RIGHT('0000' + CasT(I.TeacherID as VARCHAR(5)), 5)), '@fpt.edu.vn')
    FROM Teachers as T
    JOIN Inserted as I on T.TeacherID = I.TeacherID;


	-- INSERT INTO UserInformations TABLE
	INSERT INTO UserInformations (Username, Password, StudentID, TeacherID, EmployeeID, Role, LastModified)
	SELECT
		CONCAT(CONCAT(dbo.prefixEmail(inserted.TeacherName), RIGHT('0000' + CAST(inserted.TeacherID AS VARCHAR(5)), 5)), '@fpt.edu.vn'),
		CONCAT(dbo.prefixEmail(inserted.TeacherName), RIGHT('0000' + CAST(inserted.TeacherID AS VARCHAR(5)), 5)),
		NULL,
		inserted.TeacherID,
		NULL,
		'3',
		GETDATE()
	FROM inserted;

	UPDATE Teachers
	SET Teachers.Email = UserInformations.Username
	FROM Teachers
	JOIN UserInformations on Teachers.TeacherID = UserInformations.TeacherID;

	-- INSERT INTO MSSV TABLE
	INSERT INTO MSGV (TeacherID, TeacherCode)
	SELECT 
		inserted.TeacherID,
		RIGHT('0000' + CasT(inserted.TeacherID as VARCHAR(5)), 5)
	FROM inserted;
END;


-- create a new teacher
INSERT INTO Teachers
(TeacherName, Sex, DateOfBirth, PhoneNumber, Provice, MajorID, TeacherManagerID, LastModified, Descriptor)
VALUES 
(N'Nguyen Nguyen P2', '1', '1995-10-10', '0123456789', N'Hà Nội', '1', 19, GETDATE(), NULL)
select * from dbo.getTeacherManager(1)
select * from teachers

CREATE OR ALTER PROC Update_teacher 
@teacherID INT,
@sex INT,
@phoneNumber VARCHAR(10),
@provice NVARCHAR(50),
@majorID INT,
@teacherManagerID INT,
@data VARBINARY(MAX),
@lastModified DATE,
@descriptor NVARCHAR(255)
AS
BEGIN 
	SET @data = CASE WHEN @data is null THEN CONVERT(VARBINARY(MAX), '0x89504E470D0A1A0A0000000D494844520000012C0000012C0806000000797D8E7500000DF949444154785EEDDD7B7714C5DA40F1F3FDBF94120D2246F01215440515C115884A141151E65D0FABF29E3E35499864EA99A9EAF9EDB5F63F5C924E4FCF4E554D5FFEB3008041F84FFD0700D02B82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C4317C13A3E3E5E1C1C1C90ECD8A3A3A3FAADBB71BA08D6CF3FFFBC78E79D774876EC4F3FFD54BF75378E60915C49C12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255681DAC6BD7AE2DEEDEBD4BEEB47B7B7B4BEF8D7514AC42EB60BDF7DE7BF5B700768E0F3EF860E9BDB18E8255102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA23584908D662F1E2C58BC5C9C9C9E2F9F3E7F55F015742B092D8B560BD7EFD7A717C7CBCF8FAEBAF17D7AF5F5FDAFED39FE1F0F070717474B478F5EA55FD2580B7225849EC52B01E3D7A746EA4CE736F6F6F71FFFEFDC53FFFFC537F39E05C042B895D08D61F7FFCB1B879F3E6D2B65EC6FDFDFDC5D3A74FEB2F0D9C89602531F76045646294546FE755FDFEFBEFEB6F012C215849CC3958AD7FB65363FD0BB808C14AA2F59BBA97603D7BF66C71EDDAB5A5ED6B650F0710FA45B0929863B0FEFEFBEF376B4EF5B6B53462185104CE42B0929863B0BEF9E69BA5EDCAF0D6AD5BF5B7C68AFCFBEFBFF51FCD0AC14A626EC18A934033A782B54F9E3CA937012B70EFDEBD3727EBCE15C14A626EC1FAF6DB6F97B62953A3ACCBF3EBAFBF2EDE7DF7DDC5DDBB77EBBF9A0D8295C4DC82D5FA40799BF1C68B3533AC469C807BE3C68D37FB2E4E3799EB09B9AD8F43C12ACC2958718268BD3D9BB087836914622AB80BFB4EB0929853B0E245ADB76713DEB973A7DE149CC16FBFFDF666443ADD77070707F53F9B058295C49C82B5E9F5AB536FDFBE5D6F0A2AE253C1D3A960ED1C4F0F11AC24E614AC58C4ADB76713C6758AB8988B4E3599E30855B09210ACF515AC8B8911543D159C1AA7A1CCED363E8295C49C8275D16FF14C4D09CF27A6821F7EF8E1D23EAB7DF8F061FD5F8746B0929853B0B6B5E8FEE5975FD69B82C2AABF44E6364A15AC24E614AC987AD4DBB3097FFCF1C77A53B078FB54B0363E459C0B8295C49C8215B73F7EFFFDF797B629DB38FF0BFFCBAA53C1A9731AA90A5612730A56109F38D5DB94E9DCA632AD58752A383516DFE772D580602531B760C568E732D390758DFD87FFE5B253C1A973995E0B5612730B56B0A9D31B3EFAE8A337D350FC97980AAE73FFFC9846CE01C14A628EC1FAEBAFBFDE6C47BD6D2D8D11C42FBFFC527FEB9DE72A53C1DAB89BC3E8085612730C561031B9EAB464153D8C629975A68253E7B0F82E5849CC3558419C8C586F5F0BE7F0866ACDBA53C1A973587C17AC24E61CACE0F1E3C74DEF401A531EEB56CB7CF7DD774BFB6A1D7FF8E187FA5B0C85602531F76005315559F7008A9F2BE28765E256C72DA68253E3CE0E23B3EEF1562B58855D0856105396F8AD7DD9C5F8189DC57308479FA264D1722A583BF2871A8295C4AE04EB94B82BC0D1D1D1E2F0F0F0DC78C568E1D34F3F7DB306169F38E27C5A4F05A7C66B342A8295C4AE05AB26EE291E539A535FBE7C59FF139C43C654706A8C6E477D3D042B895D0F16AE46E65470EAA8A78F08561282D52FBFFFFE7BB70F1CBD7FFFFED26B9F61BCF147FC5456B09210AC3E89A96A1CF4B196D65BB422A42D4F15799BC7C7C7F526748F602521587D327DA0C6679F7DD64DB4623BE21ACAFA75CFF4F3CF3FAF37A37B042B09C1EA8FB34630BD446B5353C1A9B1B03FDAA7B582958460F5C7AD5BB796F66B18238D6D46EBAC906ECA08E54808561282D5177160D6FB74EAB6A2B58DA9E0D4EBD7AF0FB5F82E584908563FC4D9F4ABDCE2791BD1DAC654B0F6E9D3A7F566758B60252158FD107781A8F7E7796E325A7117D76D4D05A7C63ADE2808561282D507F1C4987A5FBECDB874253B5A310D3B383858FADEDB3016DF5FBC78516F629708561282B57D223A977DC2CCA911ADCCB59D070F1E2C7DCF6D3ACAE2BB60252158DB272E3FA9F7E365CC8A562F53C1A9FBFBFB293F6B6B042B09C1DA2E7FFEF96793287CF1C5174DDFC83D4D056B9F3C79526F6E7708561282B55D6221B9DE8757B565B47A9B0A4EFDE4934FEACDED0EC14A42B0B647EB7D1FC6278DEB46ABC7A9E0D4587C8F9169CF085612ADDF3482B51A7171739C0C59EFBF16AE13ADF87F1F7FFCF1D2D7ECCDB8D6B267042B09C1DA0ED90F7BBD6AB4E236D2F5D7EAD1587CCF3EA5631D042B09C1DA3C714D5EE69D3A4FFDEAABAF2E15ADE7CF9F773D15AC8D5B5DF78A602521589B2502B2C96BF2225AAB30CA54706ACF8BEF829584606D96B75DDC9CE12AD11A652A58DBEBE2BB602521589B23EEE9B4B7B7B7B4CF36E19D3B77EACDF97F469B0A4E8D07DBF6886025B1CBC1DAF4A2ED652E6ECEF0AC688D38159C1A77B7D8F4EBB80A8295C4AE062B1ED2B9C9FBA5C7AD51EA7DB50DEB688D3A159C1AC7706F085612BB1AACD351452CDC66472BBE7E3C7ABDDE57DB324EA9085A5D16B46DE30EADBD215849EC62B0627435DDE6EC684D1F28D18B11AD91A782B5B10ED7138295C42E06EBAC37EAEDDBB753A235F282F648DEBB77AFDEF55B45B092D8B560D5A3ABA931B5884B665A72DE0325D8D6DE16DF052B895D0BD659A3ABA92DA3D57ADFF2621F3F7E5CBF045B43B09268FDA6EA3958178DAEA646D45EBD7A55FFF74BB1EA0325D8CE78DD7A41B092D8A560BD6D743575DD68655FDCCCB38D5BE3F4806025B12BC15A75743535EEB87995685DE581126CE3E9291BDB46B092D895605D66743535A215D3BB55D9F6034777DD38FE5AAD41AE836025B10BC1BACAE86A6A0468D568ADFB4009AEEFA3478FEA9765E3085612BB10ACAB8EAEA6AE12AD7866DEB62E6EE67FED61F15DB092987BB0D61D5D4DBD79F3E685D16AF94009AEE7C9C949FDF26C14C14A62EEC16A31BA9A1AD17AF9F265FD6DDE3C7AAAFEB7DC9EDB5E7C17AC24E61CAC96A3ABA975B4321F28C1AB1953F36D2EBE0B5612730E56EBD1D5D478B47CDC902F889BC8D57FCFEDBBCD37B9602531D760658DAEA646B4E23E579B78A0042F6F7C50B22D042B89B9062B7374C5717CF6EC597D686C04C14A628EC1DAC4E88A63B8CA03383210AC24E6182CA32B9E1AF722BBCAE555EB225849CC2D584657AC7DF8F0617D98A4235849CC2D584657AC8DD350368D602531A760195DF13CE30E1A9B44B0929853B08CAE789EF14CC84D225849CC25584657BCC8587CBFE83AD0D6085612730996D115DF663C347653085612730896D1155731AE4CD8148295C41C826574C5558D5F6E9B40B092183D584657BC8C9B5A7C17AC24460F96D1152FE3A616DF052B8991836574C5ABB889C577C14A62E460195DF12ADEB871A33E949A2358498C1A2CA32BAE63F6E2BB6025316AB08CAEB88E878787F521D514C14A62C460195D715DE32EB1673D4CA4158295C488C132BA620B1F3C78501F5ACD10AC24460B96D1155B195179FDFA757D883541B092182D58F1C2C533E7C816C6D3BA3310AC24460B1630028295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F6025D13A587B7B7B8B93931372A7DDDFDF5F7A6FACA360155A078B647B05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC102804B2058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C320580086E1FF003B3B5E31DD23C9C30000000049454E44AE426082') 
	ELSE @data END
	UPDATE Teachers
	SET 
	Teachers.Sex = @sex,
	Teachers.phoneNumber = @phoneNumber,
	Teachers.provice = @provice,
	Teachers.majorID = @majorID,
	Teachers.photo = @data,
	Teachers.lastModified = @lastModified,
	Teachers.descriptor = @descriptor
	WHERE Teachers.TeacherID = @teacherID;

	IF @teacherManagerID IS NULL
	BEGIN 
		UPDATE Teachers
		SET Teachers.TeacherManagerID = @teacherID 
		WHERE Teachers.MajorID = @majorID AND Teachers.TeacherID <> @teacherID;

		UPDATE Teachers
		SET Teachers.TeacherManagerID = NULL 
		WHERE Teachers.TeacherID = @teacherID;
	END

END




-- Function lấy thông tin của quản lý môn từ -> mã ngành
CREATE OR ALTER function getTeacherManager(@majorID INT)
RETURNS TABLE
as
RETURN
SELECT
	t1.TeacherID, t1.TeacherName, t1.Email, t1.Sex, t1.DateOfBirth,
	t1.PhoneNumber, t1.Provice, t1.MajorID, t1.TeacherManagerID, t1.Photo,
	t1.LastModified, t1.Descriptor

	FROM teachers as t1
	-- LEFT JOIN teachers as t2 on t1.TeacherID = t2.TeacherManagerID
	WHERE t1.MajorID = @majorID AND t1.TeacherManagerID is null
	group by 
	t1.TeacherID, t1.TeacherName, t1.Email, t1.Sex,
	t1.DateOfBirth, t1.PhoneNumber, t1.Provice, t1.MajorID,
	t1.TeacherManagerID, t1.Photo, t1.LastModified, t1.Descriptor;

select * from teachers



-- View lấy ra toàn bộ giáo viên chưa xóa
CREATE OR ALTER view v_getListTeacher
as
SELECT * FROM teachers WHERE teachers.isDelete = 0



-- Function lấy thông tin của giảng viên từ -> mã giảng viên
CREATE OR ALTER function getTeacherByTeacherID (@teacherID INT) 
RETURNS TABLE
as
RETURN 
SELECT 
	Teachers.teacherID,
	Teachers.teacherName,
	Teachers.email,
	Teachers.sex,
	Teachers.dateOfBirth,
	Teachers.PhoneNumber,
	Teachers.Provice,
	Teachers.MajorID,
	Teachers.TeacherManagerID,
	Teachers.Photo,
	Teachers.LastModified,
	Teachers.Descriptor

	FROM Teachers WHERE Teachers.TeacherID  = @teacherID AND Teachers.isDelete = 0


-- Lấy thông tin giáo viên từ TeachingassignmentID
CREATE OR ALTER function getTeacherByTasm (@TeachingasmID INT)
RETURNS TABLE
as
RETURN
SELECT 
	Teachers.teacherID,
	Teachers.teacherName,
	Teachers.email,
	Teachers.sex,
	Teachers.dateOfBirth,
	Teachers.PhoneNumber,
	Teachers.Provice,
	Teachers.MajorID,
	Teachers.TeacherManagerID,
	Teachers.Photo,
	Teachers.LastModified,
	Teachers.Descriptor
	FROM Teachers
	JOIN Teachingassignments on Teachers.TeacherID = Teachingassignments.TeacherID 
	WHERE Teachingassignments.TeachingassignmentID = @TeachingasmID

SELECT * FROM getTeacherNameByTasm(1)



-- Lấy ra thông tin giáo viên từ ID Major
CREATE OR ALTER function getTeacherByMajorID (@MajorID INT, @isDelete INT) 
RETURNS TABLE
as
RETURN
SELECT 
	t.TeacherID,
	t.TeacherName,
	t.sex,
	t.Email,
	t.DateOfBirth,
	t.PhoneNumber,
	t.Provice,
	t.MajorID,
	t.TeacherManagerID,
	t.Photo,
	t.LastModified,
	t.Descriptor
	FROM teachers t
	JOIN majors on t.majorid = majors.majorid 
	WHERE t.majorid = @MajorID AND t.isdelete = @isDelete

SELECT * FROM dbo.getTeacherByMajorID(2)