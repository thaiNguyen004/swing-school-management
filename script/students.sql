-- trigger - proc - function -- Students

create or alter function getStudentByUsername (@username varchar(50))
returns table 
as
return
select 
	s.StudentID,
	s.FullName,
	s.Sex,
	s.Batch,
	s.DateOfBirth,
	s.Email,
	s.PhoneNumber,
	s.Provice,
	sp.SpecificallyMajorName,
	s.Photo,
	s.LastModified,
	s.Descriptor
	from students s
	join UserInformations u on s.Email = u.Username
	join SpecificallyMajors sp on sp.SpecificallyMajorID = s.SpecificallyMajorID
	where s.Email = @username

	select * from UserInformations
	select * from dbo.getStudentByUsername('dungbhph00002@fpt.edu.vn')

-- Update email student
CREATE OR ALTER TRIGGER UpdateStudentEmail on Students
AFTER INSERT, UPDATE
as
BEGIN
    UPDATE S
    SET S.Email = ConCAT(ConCAT(concat(dbo.prefixEmail(I.FullName), 'ph'), RIGHT('0000' + CasT(I.StudentID as VARCHAR(5)), 5)), '@fpt.edu.vn')
    FROM Students as S
    JOIN Inserted as I on S.StudentID = I.StudentID;
END;



CREATE OR ALTER TRIGGER trigger_Create_Student
on Students
AFTER INSERT
as
BEGIN
	-- Update Students TABLE
	UPDATE Students
	SET Photo = CASE WHEN inserted.Photo IS NULL THEN CONVERT(VARBINARY(MAX), '0x89504E470D0A1A0A0000000D494844520000012C0000012C0806000000797D8E7500000DF949444154785EEDDD7B7714C5DA40F1F3FDBF94120D2246F01215440515C115884A141151E65D0FABF29E3E35499864EA99A9EAF9EDB5F63F5C924E4FCF4E554D5FFEB3008041F84FFD0700D02B82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C4317C13A3E3E5E1C1C1C90ECD8A3A3A3FAADBB71BA08D6CF3FFFBC78E79D774876EC4F3FFD54BF75378E60915C49C12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255681DAC6BD7AE2DEEDEBD4BEEB47B7B7B4BEF8D7514AC42EB60BDF7DE7BF5B700768E0F3EF860E9BDB18E8255102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA23584908D662F1E2C58BC5C9C9C9E2F9F3E7F55F015742B092D8B560BD7EFD7A717C7CBCF8FAEBAF17D7AF5F5FDAFED39FE1F0F070717474B478F5EA55FD2580B7225849EC52B01E3D7A746EA4CE736F6F6F71FFFEFDC53FFFFC537F39E05C042B895D08D61F7FFCB1B879F3E6D2B65EC6FDFDFDC5D3A74FEB2F0D9C89602531F76045646294546FE755FDFEFBEFEB6F012C215849CC3958AD7FB65363FD0BB808C14AA2F59BBA97603D7BF66C71EDDAB5A5ED6B650F0710FA45B0929863B0FEFEFBEF376B4EF5B6B53462185104CE42B0929863B0BEF9E69BA5EDCAF0D6AD5BF5B7C68AFCFBEFBFF51FCD0AC14A626EC18A934033A782B54F9E3CA937012B70EFDEBD3727EBCE15C14A626EC1FAF6DB6F97B62953A3ACCBF3EBAFBF2EDE7DF7DDC5DDBB77EBBF9A0D8295C4DC82D5FA40799BF1C68B3533AC469C807BE3C68D37FB2E4E3799EB09B9AD8F43C12ACC2958718268BD3D9BB087836914622AB80BFB4EB0929853B0E245ADB76713DEB973A7DE149CC16FBFFDF666443ADD77070707F53F9B058295C49C82B5E9F5AB536FDFBE5D6F0A2AE253C1D3A960ED1C4F0F11AC24E614AC58C4ADB76713C6758AB8988B4E3599E30855B09210ACF515AC8B8911543D159C1AA7A1CCED363E8295C49C8275D16FF14C4D09CF27A6821F7EF8E1D23EAB7DF8F061FD5F8746B0929853B0B6B5E8FEE5975FD69B82C2AABF44E6364A15AC24E614AC987AD4DBB3097FFCF1C77A53B078FB54B0363E459C0B8295C49C8215B73F7EFFFDF797B629DB38FF0BFFCBAA53C1A9731AA90A5612730A56109F38D5DB94E9DCA632AD58752A383516DFE772D580602531B760C568E732D390758DFD87FFE5B253C1A973995E0B5612730B56B0A9D31B3EFAE8A337D350FC97980AAE73FFFC9846CE01C14A628EC1FAEBAFBFDE6C47BD6D2D8D11C42FBFFC527FEB9DE72A53C1DAB89BC3E8085612730C561031B9EAB464153D8C629975A68253E7B0F82E5849CC3558419C8C586F5F0BE7F0866ACDBA53C1A973587C17AC24E61CACE0F1E3C74DEF401A531EEB56CB7CF7DD774BFB6A1D7FF8E187FA5B0C85602531F76005315559F7008A9F2BE28765E256C72DA68253E3CE0E23B3EEF1562B58855D0856105396F8AD7DD9C5F8189DC57308479FA264D1722A583BF2871A8295C4AE04EB94B82BC0D1D1D1E2F0F0F0DC78C568E1D34F3F7DB306169F38E27C5A4F05A7C66B342A8295C4AE05AB26EE291E539A535FBE7C59FF139C43C654706A8C6E477D3D042B895D0F16AE46E65470EAA8A78F08561282D52FBFFFFE7BB70F1CBD7FFFFED26B9F61BCF147FC5456B09210AC3E89A96A1CF4B196D65BB422A42D4F15799BC7C7C7F526748F602521587D327DA0C6679F7DD64DB4623BE21ACAFA75CFF4F3CF3FAF37A37B042B09C1EA8FB34630BD446B5353C1A9B1B03FDAA7B582958460F5C7AD5BB796F66B18238D6D46EBAC906ECA08E54808561282D5177160D6FB74EAB6A2B58DA9E0D4EBD7AF0FB5F82E584908563FC4D9F4ABDCE2791BD1DAC654B0F6E9D3A7F566758B60252158FD107781A8F7E7796E325A7117D76D4D05A7C63ADE2808561282D507F1C4987A5FBECDB874253B5A310D3B383858FADEDB3016DF5FBC78516F629708561282B57D223A977DC2CCA911ADCCB59D070F1E2C7DCF6D3ACAE2BB60252158DB272E3FA9F7E365CC8A562F53C1A9FBFBFB293F6B6B042B09C1DA2E7FFEF96793287CF1C5174DDFC83D4D056B9F3C79526F6E7708561282B55D6221B9DE8757B565B47A9B0A4EFDE4934FEACDED0EC14A42B0B647EB7D1FC6278DEB46ABC7A9E0D4587C8F9169CF085612ADDF3482B51A7171739C0C59EFBF16AE13ADF87F1F7FFCF1D2D7ECCDB8D6B267042B09C1DA0ED90F7BBD6AB4E236D2F5D7EAD1587CCF3EA5631D042B09C1DA3C714D5EE69D3A4FFDEAABAF2E15ADE7CF9F773D15AC8D5B5DF78A602521589B2502B2C96BF2225AAB30CA54706ACF8BEF829584606D96B75DDC9CE12AD11A652A58DBEBE2BB602521589B23EEE9B4B7B7B7B4CF36E19D3B77EACDF97F469B0A4E8D07DBF6886025B1CBC1DAF4A2ED652E6ECEF0AC688D38159C1A77B7D8F4EBB80A8295C4AE062B1ED2B9C9FBA5C7AD51EA7DB50DEB688D3A159C1AC7706F085612BB1AACD351452CDC66472BBE7E3C7ABDDE57DB324EA9085A5D16B46DE30EADBD215849EC62B0627435DDE6EC684D1F28D18B11AD91A782B5B10ED7138295C42E06EBAC37EAEDDBB753A235F282F648DEBB77AFDEF55B45B092D8B560D5A3ABA931B5884B665A72DE0325D8D6DE16DF052B895D0BD659A3ABA92DA3D57ADFF2621F3F7E5CBF045B43B09268FDA6EA3958178DAEA646D45EBD7A55FFF74BB1EA0325D8CE78DD7A41B092D8A560BD6D743575DD68655FDCCCB38D5BE3F4806025B12BC15A75743535EEB87995685DE581126CE3E9291BDB46B092D895605D66743535A215D3BB55D9F6034777DD38FE5AAD41AE836025B10BC1BACAE86A6A0468D568ADFB4009AEEFA3478FEA9765E3085612BB10ACAB8EAEA6AE12AD7866DEB62E6EE67FED61F15DB092987BB0D61D5D4DBD79F3E685D16AF94009AEE7C9C949FDF26C14C14A62EEC16A31BA9A1AD17AF9F265FD6DDE3C7AAAFEB7DC9EDB5E7C17AC24E61CAC96A3ABA975B4321F28C1AB1953F36D2EBE0B5612730E56EBD1D5D478B47CDC902F889BC8D57FCFEDBBCD37B9602531D760658DAEA646B4E23E579B78A0042F6F7C50B22D042B89B9062B7374C5717CF6EC597D686C04C14A628EC1DAC4E88A63B8CA03383210AC24E6182CA32B9E1AF722BBCAE555EB225849CC2D584657AC7DF8F0617D98A4235849CC2D584657AC8DD350368D602531A760195DF13CE30E1A9B44B0929853B08CAE789EF14CC84D225849CC25584657BCC8587CBFE83AD0D6085612730996D115DF663C347653085612730896D1155731AE4CD8148295C41C826574C5558D5F6E9B40B092183D584657BC8C9B5A7C17AC24460F96D1152FE3A616DF052B8991836574C5ABB889C577C14A62E460195DF12ADEB871A33E949A2358498C1A2CA32BAE63F6E2BB6025316AB08CAEB88E878787F521D514C14A62C460195D715DE32EB1673D4CA4158295C488C132BA620B1F3C78501F5ACD10AC24460B96D1155B195179FDFA757D883541B092182D58F1C2C533E7C816C6D3BA3310AC24460B1630028295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F60252158407B042B09C102DA2358490816D01EC14A42B080F60856128205B447B092102CA03D8295846001ED11AC24040B688F6025D13A587B7B7B8B93931372A7DDDFDF5F7A6FACA360155A078B647B05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC12A0816D9BF8255102CB27F05AB205864FF0A5641B0C8FE15AC826091FD2B5805C122FB57B00A8245F6AF6015048BEC5FC102804B2058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C32058008641B0000C8360011806C102300C82056018040BC03008168061102C00C320580086E1FF003B3B5E31DD23C9C30000000049454E44AE426082') ELSE inserted.Photo END,
		isDelete = 0
	FROM Students
	INNER JOIN inserted on Students.studentID = inserted.studentID;

	-- INSERT INTO UserInformations TABLE
	INSERT INTO UserInformations (Username, Password, StudentID, TeacherID, EmployeeID, Role, LastModified)
	SELECT
		ConCAT(ConCAT(concat(dbo.prefixEmail(inserted.FullName), 'ph'), RIGHT('0000' + CasT(inserted.StudentID as VARCHAR(5)), 5)), '@fpt.edu.vn'),
		CONCAT(dbo.prefixEmail(inserted.FullName), RIGHT('0000' + CAST(inserted.StudentID as VARCHAR(5)), 5)),
		inserted.studentid,
		NULL,
		NULL,
		'4',
		GETDATE()
	FROM inserted;

	-- INSERT INTO MSSV TABLE
	INSERT INTO MSSV (StudentID, StudentCode)
	SELECT 
		inserted.StudentID,
		RIGHT('0000' + CasT(inserted.StudentID as VARCHAR(5)), 5)
	FROM inserted;
END

select * from students
select * from StudyingParticipations
select * from dbo.getSubjectByStudyingParticipations(16)

-- update student ----------------------------
CREATE OR ALTER PROC UpdateStudent
@StudentName NVARCHAR(50),
@Sex INT ,
@Dob DATE,
@PhoneNumber VARCHAR(10),
@Provice NVARCHAR(50),
@Photo VARBINARY(MAX),
@Batch INT,
@SpecificallyMajorID INT,
@LastModified DATE,
@Descriptor NVARCHAR(50),
@StudentID INT
as
BEGIN
	UPDATE Students
	SET Students.FullName = @StudentName,
	Students.Sex = @Sex,
	Students.DateOfBirth = @Dob,
	Students.PhoneNumber = @PhoneNumber,
	Students.Provice = @Provice,
	Students.Photo = @Photo,
	Students.Batch = @Batch,
	Students.SpecificallyMajorID = @SpecificallyMajorID,
	Students.LastModified = @LastModified,
	Students.Descriptor = @Descriptor
	WHERE Students.StudentID = @StudentID
END




-- lấy thông tin sinh viên từ giới tính
CREATE OR ALTER Function getStudentBySex (@Sex INT)
RETURNS TABLE
AS
RETURN 
SELECT 
Students.StudentID, 
Students.FullName, 
Students.Sex, 
Students.Batch, 
Students.DateOfBirth, 
Students.Email, 
Students.PhoneNumber, 
Students.Provice, 
SpecificallyMajors.SpecificallyMajorName, 
Students.Photo, 
Students.LastModified, 
Students.Descriptor
FROM Students
JOIN SpecificallyMajors on SpecificallyMajors.SpecificallyMajorID = Students.SpecificallyMajorID
WHERE Students.Sex = @Sex AND students.isDelete = 0
SELECT * FROM DBO.getStudentBySex(1);



-- Lấy sinh viên từ mã sinh viên
CREATE OR ALTER FUNCTIon getStudent (@ID INT)
RETURNS TABLE
as
RETURN
SELECT 
	Students.StudentID, 
	Students.FullName, 
	Students.Sex, 
	Students.Batch, 
	Students.DateOfBirth, 
	Students.Email, 
	Students.PhoneNumber, 
	Students.Provice, 
	SpecificallyMajors.SpecificallyMajorName,
	Students.Photo,
	Students.LastModified,
	Students.Descriptor 
    FROM Students
	JOIN SpecificallyMajors on SpecificallyMajors.SpecificallyMajorID = Students.SpecificallyMajorID
	WHERE Students.StudentID = @ID AND Students.isDelete = 0

SELECT * FROM DBO.getStudent(11)



-- Lấy sinh viên từ id ngành hẹp
CREATE OR ALTER function getStudentBySpecificallyMajorID(@SpecificallyMajorID INT, @isDelete int)
RETURNS TABLE
as
RETURN
SELECT 
b.StudentID, 
b.FullName, 
b.Sex, 
b.Batch, 
b.DateOfBirth, 
b.Email, 
b.PhoneNumber, 
b.Provice, 
a.SpecificallyMajorName, 
b.Photo, 
b.LastModified, 
b.Descriptor
FROM SpecificallyMajors a
JOIN Students b on a.SpecificallyMajorID = b.SpecificallyMajorID
WHERE a.SpecificallyMajorID = @SpecificallyMajorID AND b.isDelete = @isDelete

SELECT * FROM DBO.getStudentBySpecificallyMajorID(3)




-- Từ mã lớp ví dụ như SD18314 có thể lấy ra các sinh viên từ TeachingassignmentID
CREATE OR ALTER FUNCTIon getStudentByClass(@TeachingassignmentID INT)
RETURNS TABLE
as
RETURN
SELECT  Students.StudentID, Students.FullName, Students.Sex, Students.Batch, Students.DateOfBirth, Students.Email, Students.PhoneNumber, Students.Provice, SpecificallyMajors.SpecificallyMajorName, Students.Photo, Students.LastModified, Students.Descriptor
    FROM Teachingassignments
    JOIN StudyingParticipations on Teachingassignments.TeachingassignmentID =  StudyingParticipations.TeachingassignmentID
	JOIN Students on Students.StudentID = StudyingParticipations.StudentID
	JOIN SpecificallyMajors on Students.SpecificallyMajorID = SpecificallyMajors.SpecificallyMajorID
    WHERE Teachingassignments.TeachingassignmentID = @TeachingassignmentID AND students.isDelete = 0

SELECT * FROM DBO.getStudentByClass(1)

select * from dbo.getStudentBySpecificallyMajorID(1, 0)
select * from students


CREATE OR ALTER PROC getClassRoomByClassRoomID 
@classroomID INT,
@isDelete INT,
@classroomName VARCHAR(5) OUTPUT
AS
	SET @classroomName = (SELECT concat(concat(Classrooms.Descriptor, Classrooms.NumberOfFloor), RIGHT('00' + Cast(Classrooms.NumberOfRoom as varchar(2)), 2))
	FROM Classrooms WHERE Classrooms.ClassroomID = @classroomID and Classrooms.isDelete = @isDelete)

declare @a varchar(5) 
execute getClassroomByClassroomID 2, 1, @a out
print @a


CREATE OR ALTER FUNCTION getStudentHaveNotJoined(@specificallyMajorID INT, @subjectDetailID INT)
RETURNS TABLE
AS
RETURN
select
	Students.StudentID,
	Students.FullName,
	Students.Sex,
	SpecificallyMajors.SpecificallyMajorName
	from Students 
	JOIN SpecificallyMajors ON Students.SpecificallyMajorID = SpecificallyMajors.SpecificallyMajorID
	where SpecificallyMajors.SpecificallyMajorID = @specificallyMajorID and  Students.StudentID NOT IN (
		select s.StudentID from StudyingParticipations s
		join Teachingassignments t on t.TeachingassignmentID = s.TeachingassignmentID
		where t.SubjectDetailID = @subjectDetailID
	)

SELECT * FROM DBO.getStudentHaveNotJoined(1, 6)


CREATE OR ALTER FUNCTION getStudentJoinedButCanChange(@specificallyMajorID INT, @subjectDetailID INT, @status INT)
RETURNS TABLE
AS
RETURN
select
	Students.StudentID,
	Students.FullName,
	Students.Sex,
	SpecificallyMajors.SpecificallyMajorName
	from Students 
	JOIN SpecificallyMajors ON Students.SpecificallyMajorID = SpecificallyMajors.SpecificallyMajorID
	where SpecificallyMajors.SpecificallyMajorID = @specificallyMajorID and  Students.StudentID IN (
		select s.StudentID from StudyingParticipations s
		join Teachingassignments t on t.TeachingassignmentID = s.TeachingassignmentID
		where t.SubjectDetailID = @subjectDetailID AND s.Status = @status
	)


	select * from dbo.getStudentJoinedButCanChange(1, 6, 1)
	select * from StudyingParticipations
	select * from students

	select * from Subjects
	select * from SubjectsDetail



CREATE OR ALTER PROC createStudyingParticipation
@teachingAssignmentID INT,
@StudentID INT
AS
BEGIN
INSERT INTO StudyingParticipations 
(TeachingassignmentID, StudentID, Status)
VALUES
(@teachingAssignmentID, @StudentID, '1')
END

select * from teachingassignments
select * from SubjectsDetail
select * from subjects
select * from StudyingParticipations

delete from StudyingParticipations where StudyingParticipations.ParticipationID = 35

create or alter trigger initGradeOfStudent 
on StudyingParticipations
after insert
as
begin
	declare @studentID INT;
	declare @teachingAssignmentID INT;
	select @studentID = studentID from inserted;
	select @teachingAssignmentID = teachingassignmentID from inserted;

	declare @subjectID INT;
	select @subjectID = su.subjectDetailID
		from teachingAssignments te 
		join subjectsdetail su on te.subjectdetailID = su.subjectdetailID
		where te.teachingassignmentid = @teachingAssignmentID;

	insert into grades
	(studentID, SubjectDetailID, LastModified)
	values (@studentID, @subjectID, getdate())
end

execute createStudyingParticipation 10, 16
select * from userinformations

CREATE OR ALTER PROC getMemberOfClass 
@TeachingAssignmentID INT,
@isTeaching INT,
@cnt INT  OUTPUT
AS
BEGIN
SET @cnt = (SELECT count(t.TeachingassignmentID)
	FROM StudyingParticipations t
	JOIN Teachingassignments s ON t.TeachingassignmentID = s.TeachingassignmentID
	WHERE t.TeachingassignmentID = @TeachingAssignmentID AND s.isTeaching = @isTeaching
	GROUP BY t.TeachingassignmentID)
END
	

select * from teachingassignments
select * from studyingParticipations
select * from subjectsdetail



insert into grades
(SubjectDetailID, StudentID, LastModified)
values
 -- 1
(6, 1, getdate()),
(6, 2, getdate()),
(6, 3, getdate()),
(6, 4, getdate()),
(5, 5, getdate()),
(6, 6, getdate()),
(6, 7, getdate()),
(6, 8, getdate()),
(6, 9, getdate()),
(6, 10, getdate()),
(6, 11, getdate()),
(6, 12, getdate()),
(6, 13, getdate()),

-- 2
(5, 1, getdate()),
(5, 2, getdate()),
(5, 3, getdate()),
(5, 4, getdate()),
(5, 6, getdate()),
(5, 7, getdate()),
(5, 9, getdate()),

-- 3
(8, 1, getdate()),
(8, 2, getdate()),
(8, 3, getdate()),
(8, 4, getdate()),
(8, 6, getdate()),
(8, 7, getdate()),
(8, 9, getdate()),
(8, 6, getdate()),

-- 7
(53, 5, getdate()),
(53, 11, getdate()),
(53, 13, getdate()),
(53, 12, getdate()),

-- 8
(41, 5, getdate()),
(41, 11, getdate()),
(41, 13, getdate()),
(41, 12, getdate()),
(41, 15, getdate());



create or alter function getGradeFromStudentID (@subjectID int, @studentID int)
returns table
as
return
	select * from grades



